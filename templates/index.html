<!DOCTYPE html>
<html>
<head>
    <title>ffmpeg网页工具</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ffmpeg-simple-web</h1>
    <div class="module-container">
        <div>
            <h2>视频信息</h2>
            <form id="videoForm">
                <label for="videoPath">视频路径:</label>
                <input type="text" id="videoPath" name="video_path" required>
                <button type="submit">获取信息</button>
            </form>
            <div id="result"></div>
        </div>
        <div>
            <h2>视频截取</h2>
            <form id="trimVideoForm">
                <label for="trimVideoPath">视频路径:</label>
                <input type="text" id="trimVideoPath" name="video_path" required>
                <div class="time-inputs">
                    <label for="videoStartTime">起始时间(秒):</label>
                    <input type="number" id="videoStartTime" name="start_time" min="0" step="0.1" required>
                    <br>
                    <label for="videoEndTime">结束时间(秒):</label>
                    <input type="number" id="videoEndTime" name="end_time" min="0" step="0.1" required>
                </div>
                <button type="submit">截取视频</button>
            </form>
            <div id="trimVideoResult"></div>
        </div>
        <div>
            <h2>音频提取</h2>
            <form id="extractAudioForm">
                <label for="extractVideoPath">视频路径:</label>
                <input type="text" id="extractVideoPath" name="video_path" required>
                <button type="submit">提取音频</button>
            </form>
            <div id="extractResult"></div>
        </div>
        <div>
            <h2>音频截取</h2>
            <form id="trimAudioForm">
                <label for="trimAudioPath">音频路径:</label>
                <input type="text" id="trimAudioPath" name="audio_path" required>
                <div class="time-inputs">
                    <label for="startTime">起始时间(秒):</label>
                    <input type="number" id="startTime" name="start_time" min="0" step="0.1" required>
                    <br>
                    <label for="endTime">结束时间(秒):</label>
                    <input type="number" id="endTime" name="end_time" min="0" step="0.1" required>
                </div>
                <button type="submit">截取音频</button>
            </form>
            <div id="trimResult"></div>
        </div>
        <div>
            <h2>视频格式转换</h2>
            <form id="convertVideoForm">
                <label for="convertVideoPath">视频路径:</label>
                <input type="text" id="convertVideoPath" name="video_path" required>
                <label for="outputFormat">输出格式:</label>
                <input type="text" id="outputFormat" name="output_format" required>
                <button type="submit">转换视频</button>
            </form>
            <div id="convertResult"></div>
        </div>
        <div>
            <h2>音频转文字</h2>
            <form id="audioToTextForm">
                <label for="audioPath">音频路径:</label>
                <input type="text" id="audioPath" name="audio_path" required>
                <button type="submit">音频转文字</button>
            </form>
            <div id="audioToTextResult"></div>
        </div>

        <div>
            <h2>音频转文字 (SenseVoiceSmall)</h2>
            <form id="senseVoiceForm">
                <label for="senseVoicePath">音频路径:</label>
                <input type="text" id="senseVoicePath" name="audio_path" required>
                <button type="submit">开始转换</button>
            </form>
            <div id="senseVoiceResult"></div>
        </div>

        <div>
            <h2>文字转语音</h2>
            <form id="textToSpeechForm">
                <label for="textInput">文字:</label>
                <textarea id="textInput" name="text" required style="width: 90%;"></textarea>
                <label for="voiceSelect">音色:</label>
                <select id="voiceSelect" name="voice">
                    <option value="zf_xiaobei">女-东北</option>
                    <option value="zf_xiaoni">女-陕西</option>
                    <option value="zf_xiaoxiao">女-普通话</option>
                    <option value="zf_xiaoyi">女-普通话-卡通</option>
                    <option value="zm_yunxia">男-普通话-卡通</option>
                    <option value="zm_yunjian">男-中年-普通话</option>
                    <option value="zm_yunxi">男-青年-普通话</option>
                    <option value="zm_yunyang">男-中年-普通话2</option>
                </select>
                <button type="submit">生成语音</button>
            </form>
            <div id="textToSpeechResult"></div>
        </div>
        </div>
    </div>

    <script>
        // 添加一个处理路径的通用函数
        function processPath(path) {
            // 移除首尾的双引号（如果存在）
            return path.replace(/^"(.*)"$/, '$1');
        }
        
        document.getElementById('videoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            // 处理路径
            formData.set('video_path', processPath(formData.get('video_path')));
            
            fetch('/get_video_info', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('result');
                if (data.success) {
                    const info = data.data;
                    const format = info.format;
                    const stream = info.streams[0];
                    
                    // 转换时长
                    const duration = parseFloat(format.duration);
                    const hours = Math.floor(duration / 3600);
                    const minutes = Math.floor((duration % 3600) / 60);
                    const seconds = Math.floor(duration % 60);
                    const durationStr = `${hours}小时 ${minutes}分钟 ${seconds}秒`;
                    
                    // 使用后端已转换的文件大小
                    const size = format.size;
                    
                    // 转换比特率
                    const bitrate = (format.bit_rate / 1000000).toFixed(2); // 转换为Mbps
                    
                    // 计算帧率
                    const frameRate = eval(stream.avg_frame_rate).toFixed(2);
                    
                    resultDiv.innerHTML = `
                        <h2>视频信息</h2>
                        <p>时长: ${durationStr}</p>
                        <p>文件大小: ${size}</p>
                        <p>分辨率: ${stream.width}x${stream.height}</p>
                        <p>编码格式: ${stream.codec_name}</p>
                        <p>比特率: ${bitrate} Mbps</p>
                        <p>帧率: ${frameRate} fps</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('result').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });
        // 视频截取
        document.getElementById('trimVideoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            // 处理路径
            formData.set('video_path', processPath(formData.get('video_path')));
            fetch('/trim_video', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('trimVideoResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p>视频截取成功！保存路径：${data.output_path}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('trimVideoResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });

        // 音频提取
        document.getElementById('extractAudioForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.set('video_path', processPath(formData.get('video_path')));
            
            fetch('/extract_audio', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('extractResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p>音频提取成功！保存路径：${data.output_path}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('extractResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });
        // 音频截取
        document.getElementById('trimAudioForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.set('audio_path', processPath(formData.get('audio_path')));
            
            fetch('/trim_audio', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('trimResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p>音频截取成功！保存路径：${data.output_path}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('trimResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });

        // 视频格式转换
        document.getElementById('convertVideoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.set('video_path', processPath(formData.get('video_path')));
            
            fetch('/convert_video', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('convertResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p>视频转换成功！保存路径：${data.output_path}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('convertResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });
        // 音频转文字
        document.getElementById('audioToTextForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.set('audio_path', processPath(formData.get('audio_path')));
            
            fetch('/audio_to_text', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('audioToTextResult');
                if (data.success) {
                    resultDiv.innerHTML = `<p>转换成功！结果：${data.text}</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('audioToTextResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });
        // SenseVoiceSmall 音频转文字
        document.getElementById('senseVoiceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.set('audio_path', processPath(formData.get('audio_path')));
            
            fetch('/sense_voice', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('senseVoiceResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p>转换成功！文本内容：${data.text}</p>
                        <p>文件保存路径：${data.txt_path}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('senseVoiceResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });

        // 文字转语音
        document.getElementById('textToSpeechForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            let filename = 'audio.wav'; // 默认文件名
            fetch('/text_to_speech', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                const contentDisposition = response.headers.get('Content-Disposition');
                console.log(contentDisposition)
                if (contentDisposition) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(contentDisposition);
                    if (matches && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                document.getElementById('textToSpeechResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });
    </script>
</body>
</html>
</final_file_content>
