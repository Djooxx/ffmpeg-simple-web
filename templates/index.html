<!DOCTYPE html>
<html>
<head>
    <title>ffmpeg网页工具</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ffmpeg-simple-web</h1>
    <div class="module-container">
        <div>
            <h2>视频信息</h2>
            <form id="videoForm">
                <label for="videoPath">视频路径:</label>
                <input type="text" id="videoPath" name="video_path" required>
                <button type="submit">获取信息</button>
            </form>
            <div id="result"></div>
        </div>
        <div>
            <h2>视频截取</h2>
            <form id="trimVideoForm">
                <label for="trimVideoPath">视频路径:</label>
                <input type="text" id="trimVideoPath" name="video_path" required>
                <div class="time-inputs">
                    <label for="videoStartTime">起始时间(秒):</label>
                    <input type="number" id="videoStartTime" name="start_time" min="0" step="0.1" required>
                    <br>
                    <label for="videoEndTime">结束时间(秒):</label>
                    <input type="number" id="videoEndTime" name="end_time" min="0" step="0.1" required>
                </div>
                <button type="submit">截取视频</button>
            </form>
            <div id="trimVideoResult"></div>
        </div>
        <div>
            <h2>音频提取</h2>
            <form id="extractAudioForm">
                <label for="extractVideoPath">视频路径:</label>
                <input type="text" id="extractVideoPath" name="video_path" required>
                <button type="submit">提取音频</button>
            </form>
            <div id="extractResult"></div>
        </div>
        <div>
            <h2>音频截取</h2>
            <form id="trimAudioForm">
                <label for="trimAudioPath">音频路径:</label>
                <input type="text" id="trimAudioPath" name="audio_path" required>
                <div class="time-inputs">
                    <label for="startTime">起始时间(秒):</label>
                    <input type="number" id="startTime" name="start_time" min="0" step="0.1" required>
                    <br>
                    <label for="endTime">结束时间(秒):</label>
                    <input type="number" id="endTime" name="end_time" min="0" step="0.1" required>
                </div>
                <button type="submit">截取音频</button>
            </form>
            <div id="trimResult"></div>
        </div>
        <div>
            <h2>视频格式转换</h2>
            <form id="convertVideoForm">
                <label for="convertVideoPath">视频路径:</label>
                <input type="text" id="convertVideoPath" name="video_path" required>
                <label for="outputFormat">输出格式:</label>
                <input type="text" id="outputFormat" name="output_format" required>
                <button type="submit">转换视频</button>
            </form>
            <div id="convertResult"></div>
        </div>
        <div>
            <h2>音频转文字</h2>
            <form id="audioToTextForm">
                <label for="audioPath">音频路径:</label>
                <input type="text" id="audioPath" name="audio_path" required>
                <button type="submit">音频转文字</button>
            </form>
            <div id="audioToTextResult"></div>
        </div>

        <div>
            <h2>音频转文字(Faster Whisper)</h2>
            <form id="fasterWhisperForm">
                <label for="fasterWhisperPath">音频路径:</label>
                <input type="text" id="fasterWhisperPath" name="audio_path" required>
                <button type="submit">开始转换</button>
            </form>
            <div id="fasterWhisperResult"></div>
        </div>

        <div>
            <h2>音频转文字 (SenseVoiceSmall)</h2>
            <form id="senseVoiceForm">
                <label for="senseVoicePath">音频路径:</label>
                <input type="text" id="senseVoicePath" name="audio_path" required>
                <button type="submit">开始转换</button>
            </form>
            <div id="senseVoiceResult"></div>
        </div>

        <div>
            <h2>文字转语音</h2>
            <form id="textToSpeechForm">
                <label for="textInput">文字:</label>
                <textarea id="textInput" name="text" required style="width: 90%;max-width: 100%;"></textarea>
                <label for="voiceSelect">音色:</label>
                <select id="voiceSelect" name="voice">
                    <option value="zf_xiaobei">女-东北</option>
                    <option value="zf_xiaoni">女-陕西</option>
                    <option value="zf_xiaoxiao">女-普通话</option>
                    <option value="zf_xiaoyi">女-普通话-卡通</option>
                    <option value="zm_yunxia">男-普通话-卡通</option>
                    <option value="zm_yunjian">男-中年-普通话</option>
                    <option value="zm_yunxi">男-青年-普通话</option>
                    <option value="zm_yunyang">男-中年-普通话2</option>
                    <option value="zf_001">zf_001</option>
                    <option value="zf_002">zf_002</option>
                    <option value="zf_003">zf_003</option>
                    <option value="zf_004">zf_004</option>
                    <option value="zf_005">zf_005</option>
                    <option value="zf_006">zf_006</option>
                    <option value="zf_007">zf_007</option>
                    <option value="zf_008">zf_008</option>
                    <option value="zf_017">zf_017</option>
                    <option value="zf_018">zf_018</option>
                    <option value="zf_019">zf_019</option>
                    <option value="zf_021">zf_021</option>
                    <option value="zf_022">zf_022</option>
                    <option value="zf_023">zf_023</option>
                    <option value="zf_024">zf_024</option>
                    <option value="zf_026">zf_026</option>
                    <option value="zf_027">zf_027</option>
                    <option value="zf_028">zf_028</option>
                    <option value="zf_032">zf_032</option>
                    <option value="zf_036">zf_036</option>
                    <option value="zf_038">zf_038</option>
                    <option value="zf_039">zf_039</option>
                    <option value="zf_040">zf_040</option>
                    <option value="zf_042">zf_042</option>
                    <option value="zf_043">zf_043</option>
                    <option value="zf_044">zf_044</option>
                    <option value="zf_046">zf_046</option>
                    <option value="zf_047">zf_047</option>
                    <option value="zf_048">zf_048</option>
                    <option value="zf_049">zf_049</option>
                    <option value="zf_051">zf_051</option>
                    <option value="zf_059">zf_059</option>
                    <option value="zf_060">zf_060</option>
                    <option value="zf_067">zf_067</option>
                    <option value="zf_070">zf_070</option>
                    <option value="zf_071">zf_071</option>
                    <option value="zf_072">zf_072</option>
                    <option value="zf_073">zf_073</option>
                    <option value="zf_074">zf_074</option>
                    <option value="zf_075">zf_075</option>
                    <option value="zf_076">zf_076</option>
                    <option value="zf_077">zf_077</option>
                    <option value="zf_078">zf_078</option>
                    <option value="zf_079">zf_079</option>
                    <option value="zf_083">zf_083</option>
                    <option value="zf_084">zf_084</option>
                    <option value="zf_085">zf_085</option>
                    <option value="zf_086">zf_086</option>
                    <option value="zf_087">zf_087</option>
                    <option value="zf_088">zf_088</option>
                    <option value="zf_090">zf_090</option>
                    <option value="zf_092">zf_092</option>
                    <option value="zf_093">zf_093</option>
                    <option value="zf_094">zf_094</option>
                    <option value="zf_099">zf_099</option>
                    <option value="zm_009">zm_009</option>
                    <option value="zm_010">zm_010</option>
                    <option value="zm_011">zm_011</option>
                    <option value="zm_012">zm_012</option>
                    <option value="zm_013">zm_013</option>
                    <option value="zm_014">zm_014</option>
                    <option value="zm_015">zm_015</option>
                    <option value="zm_016">zm_016</option>
                    <option value="zm_020">zm_020</option>
                    <option value="zm_025">zm_025</option>
                    <option value="zm_029">zm_029</option>
                    <option value="zm_030">zm_030</option>
                    <option value="zm_031">zm_031</option>
                    <option value="zm_033">zm_033</option>
                    <option value="zm_034">zm_034</option>
                    <option value="zm_035">zm_035</option>
                    <option value="zm_037">zm_037</option>
                    <option value="zm_041">zm_041</option>
                    <option value="zm_045">zm_045</option>
                    <option value="zm_050">zm_050</option>
                    <option value="zm_052">zm_052</option>
                    <option value="zm_053">zm_053</option>
                    <option value="zm_054">zm_054</option>
                    <option value="zm_055">zm_055</option>
                    <option value="zm_056">zm_056</option>
                    <option value="zm_057">zm_057</option>
                    <option value="zm_058">zm_058</option>
                    <option value="zm_061">zm_061</option>
                    <option value="zm_062">zm_062</option>
                    <option value="zm_063">zm_063</option>
                    <option value="zm_064">zm_064</option>
                    <option value="zm_065">zm_065</option>
                    <option value="zm_066">zm_066</option>
                    <option value="zm_068">zm_068</option>
                    <option value="zm_069">zm_069</option>
                    <option value="zm_080">zm_080</option>
                    <option value="zm_081">zm_081</option>
                    <option value="zm_082">zm_082</option>
                    <option value="zm_089">zm_089</option>
                    <option value="zm_091">zm_091</option>
                    <option value="zm_095">zm_095</option>
                    <option value="zm_096">zm_096</option>
                    <option value="zm_097">zm_097</option>
                    <option value="zm_098">zm_098</option>
                    <option value="zm_100">zm_100</option>
                </select>
                <button type="submit">生成语音</button>
            </form>
            <div id="textToSpeechResult">
                <div id="audioControls" style="display: none;">
                    <audio id="audioPlayer" hidden></audio>
                    <button id="playPauseBtn">播放</button>
                    <input type="range" id="progressBar" value="0" style="width: 50%;">
                    <span id="timeDisplay">00:00 / 00:00</span>
                    <a id="downloadLink" style="display: block; margin-top: 15px; margin-left: 15px;">下载</a>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        // 添加一个处理路径的通用函数
        function processPath(path) {
            // 移除首尾的双引号（如果存在）
            return path.replace(/^"(.*)"$/, '$1');
        }
        
        document.getElementById('videoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            // 处理路径
            formData.set('video_path', processPath(formData.get('video_path')));
            
            fetch('/get_video_info', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('result');
                if (data.success) {
                    const info = data.data;
                    const format = info.format;
                    const stream = info.streams[0];
                    
                    // 转换时长
                    const duration = parseFloat(format.duration);
                    const hours = Math.floor(duration / 3600);
                    const minutes = Math.floor((duration % 3600) / 60);
                    const seconds = Math.floor(duration % 60);
                    const durationStr = `${hours}小时 ${minutes}分钟 ${seconds}秒`;
                    
                    // 使用后端已转换的文件大小
                    const size = format.size;
                    
                    // 转换比特率
                    const bitrate = (format.bit_rate / 1000000).toFixed(2); // 转换为Mbps
                    
                    // 计算帧率
                    const frameRate = eval(stream.avg_frame_rate).toFixed(2);
                    
                    resultDiv.innerHTML = `
                        <h2>视频信息</h2>
                        <p>时长: ${durationStr}</p>
                        <p>文件大小: ${size}</p>
                        <p>分辨率: ${stream.width}x${stream.height}</p>
                        <p>编码格式: ${stream.codec_name}</p>
                        <p>比特率: ${bitrate} Mbps</p>
                        <p>帧率: ${frameRate} fps</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('result').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });
        // 视频截取
        document.getElementById('trimVideoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            // 处理路径
            formData.set('video_path', processPath(formData.get('video_path')));
            fetch('/trim_video', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('trimVideoResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p>视频截取成功！保存路径：${data.output_path}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('trimVideoResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });

        // 音频提取
        document.getElementById('extractAudioForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.set('video_path', processPath(formData.get('video_path')));
            
            fetch('/extract_audio', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('extractResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p>音频提取成功！保存路径：${data.output_path}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('extractResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });
        // 音频截取
        document.getElementById('trimAudioForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.set('audio_path', processPath(formData.get('audio_path')));
            
            fetch('/trim_audio', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('trimResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p>音频截取成功！保存路径：${data.output_path}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('trimResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });

        // 视频格式转换
        document.getElementById('convertVideoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.set('video_path', processPath(formData.get('video_path')));
            
            fetch('/convert_video', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('convertResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p>视频转换成功！保存路径：${data.output_path}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('convertResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });
        // 音频转文字
        document.getElementById('audioToTextForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.set('audio_path', processPath(formData.get('audio_path')));
            
            fetch('/audio_to_text', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('audioToTextResult');
                if (data.success) {
                    resultDiv.innerHTML = `<p>转换成功！结果：${data.text}</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('audioToTextResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });
        // SenseVoiceSmall 音频转文字
        document.getElementById('senseVoiceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.set('audio_path', processPath(formData.get('audio_path')));
            
            fetch('/sense_voice', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('senseVoiceResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p>转换成功！文本内容：${data.text}</p>
                        <p>文件保存路径：${data.txt_path}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('senseVoiceResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });

        // 文字转语音
        document.getElementById('textToSpeechForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // 获取播放控制相关元素
            const audioControls = document.getElementById('audioControls');
            const audioPlayer = document.getElementById('audioPlayer');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const progressBar = document.getElementById('progressBar');
            const timeDisplay = document.getElementById('timeDisplay');
            const downloadLink = document.getElementById('downloadLink');
        
            // 先隐藏控制面板
            audioControls.style.display = 'none';
        
            fetch('/text_to_speech', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'audio.wav';
                if (contentDisposition) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(contentDisposition);
                    if (matches && matches[1]) filename = matches[1].replace(/['"]/g, '');
                }
                
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    
                    // 设置音频源并显示控制面板
                    audioPlayer.src = url;
                    audioControls.style.display = 'block';
                    downloadLink.href = url;
                    downloadLink.download = filename;
        
                    // 重置播放器状态
                    audioPlayer.addEventListener('loadedmetadata', () => {
                        progressBar.value = 0;
                        timeDisplay.textContent = 
                            `${formatTime(0)} / ${formatTime(audioPlayer.duration)}`;
                    });
                });
            })
            .catch(error => {
                audioControls.style.display = 'none';
                document.getElementById('textToSpeechResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });
        
        // 确保在全局作用域添加时间格式化函数
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // 添加事件监听器到播放器控件（只需要初始化一次）
        document.addEventListener('DOMContentLoaded', () => {
            const audioPlayer = document.getElementById('audioPlayer');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const progressBar = document.getElementById('progressBar');
            const timeDisplay = document.getElementById('timeDisplay');
        
            audioPlayer.addEventListener('timeupdate', () => {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressBar.value = progress;
                timeDisplay.textContent = 
                    `${formatTime(audioPlayer.currentTime)} / ${formatTime(audioPlayer.duration)}`;
            });
        
            playPauseBtn.addEventListener('click', () => {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    playPauseBtn.textContent = '暂停';
                } else {
                    audioPlayer.pause();
                    playPauseBtn.textContent = '播放';
                }
            });
        
            progressBar.addEventListener('input', (e) => {
                const time = (e.target.value / 100) * audioPlayer.duration;
                audioPlayer.currentTime = time;
            });
        
            audioPlayer.addEventListener('ended', () => {
                playPauseBtn.textContent = '播放';
                progressBar.value = 0;
            });
        });

        // Faster Whisper 音频转文字
        document.getElementById('fasterWhisperForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.set('audio_path', processPath(formData.get('audio_path')));
            
            fetch('/faster_whisper', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('fasterWhisperResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p>转换成功！字幕文件路径：${data.srt_path}</p>
                        <p>内容预览：${data.text}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">错误: ${data.error}</p>`;
                }
            })
            .catch(error => {
                document.getElementById('fasterWhisperResult').innerHTML = `<p class="error">请求失败: ${error}</p>`;
            });
        });
    </script>
</body>
</html>
</final_file_content>
